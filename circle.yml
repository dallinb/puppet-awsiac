---
machine:
  environment:
    AWS_REGION: eu-west-2
    FACTER_ensure: present

dependencies:
  cache_directories:
    - "/opt/circleci/.rvm"
    - "/home/ubuntu/.puppetlabs/etc/code/modules"
  override:
    - "bundle install"
    - "librarian-puppet install --path /home/ubuntu/.puppetlabs/etc/code/modules --verbose"

test:
  override:
    - "bundle exec rake release_checks"

compile:
  override:
    - "bundle exec rake build"

deployment:
  init:
    branch: /^(?!master$).*$/  # not the master branch
    commands:
      - "puppet module install --force --verbose pkg/locp-awsiac-0.1.0.tar.gz"
      - "./puppet_wrapper.sh apply examples/init.pp --test"
